# ==================================================================================
# MYDISPATCH AUTONOMOUS AGENT - GITHUB ACTIONS WORKFLOW
# ==================================================================================
# Version: 1.0
# Created: 2025-11-08
# Purpose: Scheduled autonomous development with safety gates
# Author: NeXify AI System
# Safety: Dry-run default, approval gates, automatic rollback
# ==================================================================================

name: Autonomous Development Agent

on:
  # ‚ö†Ô∏è CODEPILOT: Scheduled run DISABLED (needs GitHub Secrets configuration)
  # Uncomment after configuring: SUPABASE_SERVICE_ROLE_KEY, GITKRAKEN_API_TOKEN
  # schedule:
  #   - cron: "0 * * * *" # Every hour at minute 0

  # Manual trigger (dry-run default for safety)
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry-run mode (no actual changes)"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      emergency_stop:
        description: "Emergency stop (stops all autonomous work)"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

env:
  NODE_VERSION: "20"
  AUTONOMOUS_MODE: "true"

jobs:
  # ==================================================================================
  # JOB 1: PRE-FLIGHT CHECKS
  # ==================================================================================
  preflight:
    name: üîç Pre-Flight Checks
    runs-on: ubuntu-latest
    outputs:
      can_run: ${{ steps.check.outputs.can_run }}
      dry_run: ${{ steps.check.outputs.dry_run }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check system status
        id: check
        env:
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DRY_RUN_MODE: ${{ github.event.inputs.dry_run || 'true' }}
        run: |
          echo "üîç Checking autonomous system status..."
          
          # Verify required secrets are configured
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ùå ERROR: Required GitHub Secrets not configured"
            echo "Please configure VITE_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY"
            echo "See: https://github.com/MyDispatch/mydispatch-rebuild/settings/secrets/actions"
            echo "can_run=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check autonomous agent script
          if [ ! -f "scripts/autonomous-agent.ts" ]; then
            echo "‚ùå ERROR: autonomous-agent.ts script not found"
            echo "can_run=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Run status check
          npx tsx scripts/autonomous-agent.ts status || {
            echo "‚ö†Ô∏è WARNING: Status check failed, but allowing dry-run"
            echo "can_run=true" >> $GITHUB_OUTPUT
            echo "dry_run=true" >> $GITHUB_OUTPUT
            exit 0
          }

          # Check if emergency stop triggered
          if [ "${{ github.event.inputs.emergency_stop }}" == "true" ]; then
            echo "üö® Emergency stop triggered"
            npx tsx scripts/autonomous-agent.ts emergency-stop "Triggered via GitHub Actions"
            echo "can_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Default: can run
          echo "can_run=true" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN_MODE" >> $GITHUB_OUTPUT

  # ==================================================================================
  # JOB 2: EXECUTE AUTONOMOUS TASKS
  # ==================================================================================
  execute:
    name: ü§ñ Execute Autonomous Tasks
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.can_run == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config --global user.name "NeXify AI Agent"
          git config --global user.email "nexify@mydispatch.ai"

      - name: Run autonomous agent
        id: agent
        env:
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GITKRAKEN_API_TOKEN: ${{ secrets.GITKRAKEN_API_TOKEN }}
          DRY_RUN_MODE: ${{ needs.preflight.outputs.dry_run }}
          AUTONOMOUS_MODE: "true"
        run: |
          echo "ü§ñ Starting autonomous agent..."
          echo "Dry-run mode: $DRY_RUN_MODE"

          npx tsx scripts/autonomous-agent.ts

          echo "‚úÖ Agent execution completed"

      - name: Safety validation
        if: success()
        run: |
          echo "üîç Running safety validation..."
          npm run type-check
          npm run lint
          npm run test:unit
          echo "‚úÖ Safety validation passed"

      - name: Create summary
        if: always()
        run: |
          echo "## ü§ñ Autonomous Agent Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry-Run Mode:** ${{ needs.preflight.outputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ==================================================================================
  # JOB 3: POST-EXECUTION VALIDATION
  # ==================================================================================
  validate:
    name: ‚úÖ Post-Execution Validation
    runs-on: ubuntu-latest
    needs: [preflight, execute]
    if: always() && needs.execute.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run full quality check
        run: |
          echo "üîç Running comprehensive quality checks..."
          npm run quality:check
          echo "‚úÖ Quality checks passed"

      - name: Build validation
        run: |
          echo "üèóÔ∏è Validating build..."
          npm run build
          echo "‚úÖ Build successful"

      - name: Send notification
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üìß Sending completion notification..."
          # Notification will be sent by agent internally

  # ==================================================================================
  # JOB 4: ROLLBACK ON FAILURE
  # ==================================================================================
  rollback:
    name: üîÑ Rollback on Failure
    runs-on: ubuntu-latest
    needs: [execute, validate]
    if: always() && (needs.execute.result == 'failure' || needs.validate.result == 'failure')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Emergency stop
        env:
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üö® Failure detected, activating emergency stop..."
          npx tsx scripts/autonomous-agent.ts emergency-stop "Automatic rollback due to execution failure"

      - name: Rollback changes
        run: |
          echo "üîÑ Rolling back changes..."
          git reset --hard HEAD
          echo "‚úÖ Rollback completed"

      - name: Send alert
        run: |
          echo "‚ö†Ô∏è ALERT: Autonomous agent execution failed"
          echo "Rollback executed, emergency stop activated"
          # Alert will be sent by emergency stop function

# ==================================================================================
# REQUIRED SECRETS (Configure in GitHub Repository Settings)
# ==================================================================================
# üîó GitHub Repository: https://github.com/MyDispatch/mydispatch-rebuild/settings/secrets/actions
#
# MANDATORY SECRETS:
# - VITE_SUPABASE_URL: https://ygpwuiygivxoqtyoigtg.supabase.co
# - SUPABASE_SERVICE_ROLE_KEY: Get from Supabase Dashboard ‚Üí Settings ‚Üí API
#   ‚ö†Ô∏è CRITICAL: Service Role Key has admin access, never expose in frontend!
#
# OPTIONAL SECRETS:
# - GITKRAKEN_API_TOKEN: GitKraken Cloud API token (for advanced Git operations)
# - GH_PAT: GitHub Personal Access Token (for creating PRs automatically)
#
# HOW TO ADD SECRETS:
# 1. Go to: https://github.com/MyDispatch/mydispatch-rebuild/settings/secrets/actions
# 2. Click "New repository secret"
# 3. Add each secret individually
# 4. Uncomment schedule in line 13 after configuration
#
# VERIFY CONFIGURATION:
# Run manually via: Actions ‚Üí Autonomous Development Agent ‚Üí Run workflow (dry-run)
# ==================================================================================
