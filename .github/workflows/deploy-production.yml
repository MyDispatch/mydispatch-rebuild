name: ğŸš€ Production Deployment - Edge Functions + Stripe Secrets

on:
  workflow_dispatch:
    inputs:
      deploy_functions:
        description: "Deploy Edge Functions"
        required: true
        default: true
        type: boolean
      deploy_secrets:
        description: "Configure Stripe Secrets"
        required: true
        default: true
        type: boolean

env:
  PROJECT_REF: ygpwuiygivxoqtyoigtg
  FUNCTIONS_TO_DEPLOY: |
    create-checkout
    stripe-webhook
    check-subscription
    customer-portal
    send-booking-email
    send-template-email
    brain-query
    get-here-api-key

jobs:
  deploy:
    name: Deploy Edge Functions & Stripe Secrets
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Setup Supabase CLI
        run: npm install -g supabase

      - name: ğŸ”‘ Configure Supabase Access Token
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PRODUCTION }}
        run: |
          echo "âœ… Access Token configured"
          echo "   Project: ${{ env.PROJECT_REF }}"

      - name: ğŸ“¤ Deploy Critical Edge Functions
        if: ${{ inputs.deploy_functions }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PRODUCTION }}
        run: |
          echo "ğŸš€ Deploying Edge Functions..."
          echo ""

          for func in $FUNCTIONS_TO_DEPLOY; do
            echo "ğŸ“¤ Deploying: $func"
            npx supabase functions deploy "$func" --project-ref $PROJECT_REF
            echo "   âœ… $func deployed"
            echo ""
          done

      - name: ğŸ” Configure Stripe Secrets
        if: ${{ inputs.deploy_secrets }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PRODUCTION }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY_PRODUCTION }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET_PRODUCTION }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY_PRODUCTION }}
        run: |
          echo "ğŸ” Configuring Stripe Secrets in Supabase..."
          echo ""

          # Price IDs (hardcoded - aus Code extrahiert)
          declare -A SECRETS=(
            [STRIPE_SECRET_KEY]="$STRIPE_SECRET_KEY"
            [STRIPE_WEBHOOK_SECRET]="$STRIPE_WEBHOOK_SECRET"
            [STRIPE_PUBLISHABLE_KEY]="$STRIPE_PUBLISHABLE_KEY"
            [STRIPE_PRICE_STARTER_MONTHLY]="price_1SIBMrLX5M8TT990zBX6gWOm"
            [STRIPE_PRICE_STARTER_YEARLY]="price_1SIbRALX5M8TT990B81vhHPT"
            [STRIPE_PRICE_BUSINESS_MONTHLY]="price_1SIBN9LX5M8TT990mxE8owxm"
            [STRIPE_PRICE_BUSINESS_YEARLY]="price_1SIbRKLX5M8TT990e1vX4ebf"
            [STRIPE_PRICE_ENTERPRISE_MONTHLY]="price_1QkbDcC2Q9bhAGYzYf2YH6bm"
            [STRIPE_PRICE_ENTERPRISE_YEARLY]="price_1QkejZC2Q9bhAGYzIuPMEW3H"
          )

          for secret_name in "${!SECRETS[@]}"; do
            secret_value="${SECRETS[$secret_name]}"
            echo "ğŸ“ Setting: $secret_name"

            # Verwende Supabase CLI um Secrets zu setzen
            curl -X POST \
              "https://api.supabase.com/v1/projects/$PROJECT_REF/functions/secrets" \
              -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"$secret_name\",\"value\":\"$secret_value\"}"

            echo "   âœ… $secret_name configured"
            echo ""
          done

      - name: âœ… Deployment Complete
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… MyDispatch V32.5 - Production Deployment Complete!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Deployed Components:"
          echo "   âœ… 8 Critical Edge Functions"
          echo "   âœ… 9 Stripe Secrets"
          echo ""
          echo "ğŸ”— Dashboard Links:"
          echo "   - Functions: https://supabase.com/dashboard/project/${{ env.PROJECT_REF }}/functions"
          echo "   - Secrets: https://supabase.com/dashboard/project/${{ env.PROJECT_REF }}/settings/functions"
          echo "   - Production: https://www.my-dispatch.de"
          echo ""

      - name: ğŸ“§ Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ Production Deployment failed! Check workflow logs.'
            })
