# üöÄ Deployment Guide

> **Deployment & CI/CD f√ºr MyDispatch**  
> **Version:** 18.5.0  
> **Letzte Aktualisierung:** 2025-01-26

---

## üéØ Deployment-Strategie

### Environments

| Environment     | URL                       | Deploy-Trigger | Auto-Deploy |
| --------------- | ------------------------- | -------------- | ----------- |
| **Development** | `localhost:8080`          | `npm run dev`  | Nein        |
| **Staging**     | `*.lovable.app` (Preview) | Pull Request   | Ja          |
| **Production**  | `*.lovable.app`           | Push to `main` | Ja          |

---

## üîÑ CI/CD Pipeline

### GitHub Actions Workflow

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run type-check

      - name: Unit tests
        run: npm run test

      - name: Build
        run: npm run build

      - name: E2E tests
        run: npm run test:e2e
        env:
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to Production
        run: echo "Deploying to Lovable Cloud..."
```

---

## üì¶ Build Process

### Production Build

```bash
# Build erstellen
npm run build

# Output: dist/
```

### Build-Optimierungen

```typescript
// vite.config.ts
import { defineConfig } from "vite";

export default defineConfig({
  build: {
    target: "es2015",
    minify: "terser",
    terserOptions: {
      compress: {
        drop_console: true, // Remove console.log in prod
      },
    },
    rollupOptions: {
      output: {
        manualChunks: {
          "react-vendor": ["react", "react-dom", "react-router-dom"],
          "ui-vendor": ["@radix-ui/react-dialog", "@radix-ui/react-dropdown-menu"],
        },
      },
    },
  },
});
```

---

## üîê Environment Variables

### Development (.env.local)

```env
# Supabase (auto-generated by Lovable Cloud)
VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbGci...
VITE_SUPABASE_PROJECT_ID=xxx

# Testing
TEST_USER_EMAIL=test@example.com
TEST_USER_PASSWORD=test123

# Optional: External APIs
VITE_GOOGLE_MAPS_API_KEY=xxx
```

### Production (GitHub Secrets)

**NIEMALS** in `.env` committen!

1. GitHub Repository ‚Üí Settings ‚Üí Secrets
2. Secrets hinzuf√ºgen:
   - `TEST_USER_EMAIL`
   - `TEST_USER_PASSWORD`
   - `GOOGLE_MAPS_API_KEY` (falls ben√∂tigt)

---

## üß™ Pre-Deployment Checklist

### Automatische Checks

```bash
# Alle Checks ausf√ºhren
npm run pre-deploy

# Oder einzeln:
npm run lint          # ESLint
npm run type-check    # TypeScript
npm run test          # Unit Tests
npm run test:e2e      # E2E Tests
npm run build         # Production Build
```

### Quality Gates

**Pipeline stoppt bei:**

- ‚ùå ESLint Errors
- ‚ùå TypeScript Errors
- ‚ùå Test Failures
- ‚ùå Build Errors
- ‚ùå E2E Test Failures

---

## üóÑÔ∏è Database Migrations

### Lokale Migration

```bash
# Neue Migration erstellen
supabase migration new migration_name

# Migration lokal testen
supabase db reset

# Migration deployen
supabase db push
```

### Production Migration

**WICHTIG:** Migrations werden automatisch deployed!

1. Migration in `supabase/migrations/` erstellen
2. Push to `main` ‚Üí Auto-Deploy
3. Supabase wendet Migration automatisch an

**Bei Fehlern:**

```bash
# Rollback
supabase db reset --db-url <production-url>

# Alternative: Manuelle Fix-Migration
supabase migration new fix_migration
```

---

## üîç Monitoring

### Supabase Monitoring

**Dashboard:** Lovable Cloud ‚Üí Backend

**Metrics:**

- Database CPU/Memory
- API Response Times
- Error Rates
- Active Connections

### Error Tracking (Optional: Sentry)

```typescript
// src/main.tsx
import * as Sentry from "@sentry/react";

Sentry.init({
  dsn: import.meta.env.VITE_SENTRY_DSN,
  environment: import.meta.env.MODE,
  tracesSampleRate: 0.1,
});
```

---

## üö® Rollback Strategy

### Option 1: Git Revert

```bash
# Letzten Commit r√ºckg√§ngig machen
git revert HEAD
git push origin main

# Lovable Cloud deployed automatisch alte Version
```

### Option 2: Lovable Cloud Rollback

1. Lovable Dashboard ‚Üí Project Settings
2. Version History ‚Üí Vorherige Version ausw√§hlen
3. "Restore" klicken

---

## üîÑ Deployment Workflow

### Feature-Branch Workflow

```bash
# 1. Feature-Branch erstellen
git checkout -b feature/new-feature

# 2. Entwickeln + Committen
git add .
git commit -m "feat: Neue Feature-Implementierung"

# 3. Tests lokal ausf√ºhren
npm run test
npm run test:e2e

# 4. Push + Pull Request
git push origin feature/new-feature

# 5. PR Review + Merge
# ‚Üí Auto-Deploy nach Staging (Preview)

# 6. Nach Approval: Merge to main
# ‚Üí Auto-Deploy nach Production
```

---

## üìä Performance Monitoring

### Web Vitals

```typescript
// src/main.tsx
import { getCLS, getFID, getFCP, getLCP, getTTFB } from "web-vitals";

function sendToAnalytics(metric) {
  console.log(metric);
  // Optional: Send to analytics service
}

getCLS(sendToAnalytics);
getFID(sendToAnalytics);
getFCP(sendToAnalytics);
getLCP(sendToAnalytics);
getTTFB(sendToAnalytics);
```

### Performance Budget

| Metric                         | Budget  | Critical |
| ------------------------------ | ------- | -------- |
| FCP (First Contentful Paint)   | < 1.8s  | < 3s     |
| LCP (Largest Contentful Paint) | < 2.5s  | < 4s     |
| TTI (Time to Interactive)      | < 3.8s  | < 7.3s   |
| CLS (Cumulative Layout Shift)  | < 0.1   | < 0.25   |
| Bundle Size                    | < 500KB | < 1MB    |

---

## üîê Security Pre-Deployment

### Security Linter

```bash
# Supabase Security Check
supabase test db

# Output: Liste aller Security-Warnungen
# - Tabellen ohne RLS
# - Fehlende Policies
# - Unsichere Functions
```

### Security Checklist

```
[ ] RLS auf allen Tabellen aktiviert
[ ] Policies f√ºr alle CRUD-Operationen
[ ] Input-Validation (Zod + DB-Trigger)
[ ] XSS-Prevention (DOMPurify)
[ ] Secrets nicht im Code
[ ] CSP Header gesetzt
[ ] Rate Limiting aktiv
```

---

## üåê CDN & Caching

### Vite Build Caching

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        // Cache-Busting via Hash
        entryFileNames: "assets/[name].[hash].js",
        chunkFileNames: "assets/[name].[hash].js",
        assetFileNames: "assets/[name].[hash].[ext]",
      },
    },
  },
});
```

---

## üöÄ Post-Deployment

### Smoke Tests

```bash
# Automatische Smoke Tests nach Deployment
npm run test:smoke

# Pr√ºft:
# - Homepage l√§dt
# - Login funktioniert
# - Dashboard zug√§nglich
```

### Manual QA Checklist

```
[ ] Homepage l√§dt korrekt
[ ] Login/Logout funktioniert
[ ] Dashboard zug√§nglich
[ ] Buchung erstellen funktioniert
[ ] Mobile-Ansicht OK
[ ] Performance OK (< 3s LCP)
```

---

## üìû Incident Response

### Bei Produktions-Fehler

1. **Sofort:** Rollback (siehe oben)
2. **Logs pr√ºfen:** Lovable Cloud ‚Üí Backend ‚Üí Logs
3. **Fix erstellen:** Hotfix-Branch
4. **Testen:** Lokal + E2E
5. **Deploy:** Fast-Track via `main`
6. **Post-Mortem:** Lessons Learned dokumentieren

---

## üìö Weitere Ressourcen

- [Testing Guide](./Testing.md) - Test-Strategie
- [Performance Guide](./Performance.md) - Optimierung
- [Security Guidelines](../04-GOVERNANCE/Security.md) - Security Best Practices

---

## üìù Changelog

### V18.5.0 (2025-01-26)

- Erstversion Deployment Guide
- CI/CD Pipeline dokumentiert
- Rollback-Strategie definiert
- Security Pre-Deployment Checks

---

**KRITISCH:** Diese Deployment-Prozesse sind ZWINGEND f√ºr Production-Deployments.
